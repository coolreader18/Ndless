#!/bin/bash

function usage() {
	echo "Usage: nspire-tools <command> <args>"
	echo "   new <program>:   Generate a standard Makefile for <program>.tns"
	echo "   main:            Create an empty main.c"
	echo "   path:            Print out the path of the ndless installation directory"
	echo "   gcc <args...>:   Run arm-none-eabi-gcc with arguments. Usually prefer the nspire-gcc command over this."
	echo "   toolchainbin:    Print out the path of the directory that has the binaries for Ndless' arm-none-eabi toolchain."
}


UNAME="$(uname -s | tr A-Z a-z)"

# DIRNAME may not be in the toolchain directory if this script was symlinked.
# try to find the symlink target	
{
  if which realpath; then
    alias realpath=realpath
  elif readlink -f /; then
    alias realpath='readlink -f'
  elif which readlink; then
    alias realpath=readlink
  else
    alias realpath=false
  fi

  real0="$(realpath "$0")" || real0=$0
  DIRNAME="$(dirname "$real0")"
} >/dev/null 2>&1


# Cygwin owns a dedicated command to find the symlink target
if [ "$UNAME" = "cygwin" ]; then
	DIRNAME="$(cygpath --path --windows "$BINPATH")"
fi
NDLESS="$(dirname "$DIRNAME")"

if [ $# -eq 0 ]; then
	usage
	exit 0
fi

# following functions can be patched when packaging/distributing
toolchainbin() {
	echo "$NDLESS/toolchain/install/bin"
}
zehn_loader_path() {
	MAKEFLAGS='' make -C "${NDLESS}/tools/zehn_loader" -s all
	local suffix=$1
	echo "$NDLESS/tools/zehn_loader/zehn_loader$suffix.tns"
}

cmd=$1
shift
case "$cmd" in
	new)
		if [ -f Makefile ]; then
			if [ $# -eq 0 ]; then
				usage
				exit 1
			fi
			echo -n "Makefile already exists. Overwrite? (y/n) "
			read yn
			if [ "$yn" != "y" ]; then
				exit 0
			fi
		fi
		prgmname="$(echo "$1" | tr -d ' ')"
		sed -e "s/@@EXENAME@@/${prgmname}/" "${DIRNAME}/Makefile.tpl" > Makefile
		echo "Makefile created."
		;;
	main)
		if [ -f main.c ]; then
			echo -n "main.c already exists. Overwrite? (y/n) "
			read yn
			if [ "$yn" != "y" ]; then
				exit 0
			fi
		fi
		cp "${DIRNAME}/main.c.tpl" main.c
		;;
	path)
		echo "$NDLESS/"
		;;
	gcc)
		GCC=$(toolchainbin)/arm-none-eabi-gcc
		exec "$GCC" "$@"
		;;
	toolchainbin)
		toolchainbin
		;;
	_zehnpath)
		zehn_loader_path "$1"
		;;
	*)
		usage
		exit 1
esac
